<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC Defect Submission</title>
<style>
  body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
  .row { display: flex; margin-bottom: 10px; flex-wrap: wrap; }
  .row label { flex: 1; min-width: 120px; }
  .row input, .row textarea { flex: 2; min-width: 150px; padding: 5px; }
  .photoPreviewContainer { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
  .photoPreviewContainer img { width: 80px; height: 80px; object-fit: cover; border: 1px solid #ccc; }
  button { padding: 10px 15px; margin-top: 10px; width: 100%; }
  #submitMessage { margin-top: 10px; font-weight: bold; color: green; }
</style>
</head>
<body>

<h2>QC Defect Submission</h2>

<form id="defectForm" method="POST" target="hidden_iframe"
      action="https://script.google.com/macros/s/AKfycbwPdNZO3f0Cnd4Rq80dcVvqBbo301qlsQX24BlFCmV4C1Qn0RxAFcnYYrchtpfFL_BV/exec">

  <div class="row">
    <label for="salesOrder">Sales Order No.</label>
    <input type="text" name="salesOrder" id="salesOrder" required>
  </div>

  <div class="row">
    <label for="itemNo">Item No.</label>
    <input type="text" name="itemNo" id="itemNo" required>
  </div>

  <div class="row">
    <label for="customerName">Customer Name</label>
    <input type="text" name="customerName" id="customerName" required>
  </div>

  <div class="row">
    <label for="itemName">Item Name</label>
    <input type="text" name="itemName" id="itemName" required>
  </div>

  <div class="row">
    <label for="defectDesc">Defect Description</label>
    <textarea name="defectDesc" id="defectDesc" rows="3" required></textarea>
  </div>

  <div class="row">
    <label for="defectCount">Defective Item Count</label>
    <input type="number" name="defectCount" id="defectCount" required>
  </div>

  <div class="row">
    <label>Photos (up to 5)</label>
    <button type="button" id="takePhotoBtn">ðŸ“· Take Photo</button>
    <input type="file" accept="image/*" id="photoInput">
    <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display:none;">
  </div>

  <input type="hidden" name="user" id="userField">
  <!-- äº”å¼ å›¾ç‰‡ Base64 éšè—åŸŸ -->
  <input type="hidden" name="imageBase64_1" id="imageBase64_1">
  <input type="hidden" name="imageBase64_2" id="imageBase64_2">
  <input type="hidden" name="imageBase64_3" id="imageBase64_3">
  <input type="hidden" name="imageBase64_4" id="imageBase64_4">
  <input type="hidden" name="imageBase64_5" id="imageBase64_5">

  <div class="photoPreviewContainer" id="photoPreviewContainer"></div>

  <button type="submit">Submit</button>
</form>

<div id="submitMessage"></div>
<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
const maxPhotos = 5;
const previews = [];
let photoIndex = 0;

// èŽ·å– URL å‚æ•°
function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

// è‡ªåŠ¨å¡«å…¥ user
const userFromUrl = getQueryParam('user');
if (userFromUrl) document.getElementById('userField').value = userFromUrl;

// åŽ‹ç¼©å›¾ç‰‡
async function compressImage(file, maxWidth = 1024, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const scale = Math.min(1, maxWidth / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

// Blob è½¬ Base64
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// æ·»åŠ ç…§ç‰‡åˆ° form
async function addPhoto(file) {
  if (photoIndex >= maxPhotos) {
    alert(`You can upload up to ${maxPhotos} photos only.`);
    return;
  }
  const compressed = await compressImage(file);
  const base64 = await blobToBase64(compressed);

  photoIndex++;
  document.getElementById(`imageBase64_${photoIndex}`).value = base64;

  const img = document.createElement('img');
  img.src = URL.createObjectURL(compressed);
  document.getElementById('photoPreviewContainer').appendChild(img);
}

// ä¸Šä¼ å›¾ç‰‡
document.getElementById('photoInput').addEventListener('change', async e => {
  if (!e.target.files || e.target.files.length === 0) return;
  for (const f of e.target.files) await addPhoto(f);
  e.target.value = '';
});

// æ‹ç…§
document.getElementById('cameraInput').addEventListener('change', async e => {
  if (!e.target.files || e.target.files.length === 0) return;
  for (const f of e.target.files) await addPhoto(f);
  e.target.value = '';
});

// ç‚¹å‡» Take Photo
document.getElementById('takePhotoBtn').addEventListener('click', () => {
  document.getElementById('cameraInput').click();
});

// Submit éªŒè¯
document.getElementById('defectForm').addEventListener('submit', e => {
  const hasPhoto = [...Array(maxPhotos).keys()].some(i => 
    document.getElementById(`imageBase64_${i+1}`).value
  );
  if (!hasPhoto) {
    e.preventDefault();
    alert("Please take a photo or choose an image before submitting.");
    return;
  }
  document.getElementById('submitMessage').textContent = "Submitting...";
});

// æˆåŠŸå›žè°ƒ
document.querySelector('iframe[name="hidden_iframe"]').addEventListener('load', () => {
  document.getElementById('submitMessage').textContent = "Form submitted successfully!";
  alert("Form submitted successfully!");
});
</script>

</body>
</html>
