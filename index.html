<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QC Defect Submission</title>
<style>
  body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
  .row { display: flex; margin-bottom: 10px; flex-wrap: wrap; }
  .row label { flex: 1; min-width: 120px; }
  .row input, .row textarea { flex: 2; min-width: 150px; padding: 5px; }
  .photoContainer { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
  .photoItem { position: relative; display: flex; flex-direction: column; align-items: center; }
  .photoItem img { width: 80px; height: 80px; object-fit: cover; border: 1px solid #ccc; }
  .removeBtn { position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px; }
  button { padding: 10px 15px; margin-top: 10px; width: 100%; }
  #submitMessage { margin-top: 10px; font-weight: bold; color: green; }
</style>
</head>
<body>

<h2>QC Defect Submission</h2>

<form id="defectForm" method="POST" target="hidden_iframe"
      action="https://script.google.com/macros/s/AKfycbzHVT6MBjnakPJ_DqaXuIOvGGQcQdYVil-NA5tr6p38r4FgLgP8GY_FsrjFs2fSSsXU/exec">

  <div class="row">
    <label for="salesOrder">Sales Order No.</label>
    <input type="text" name="salesOrder" id="salesOrder" required>
  </div>

  <div class="row">
    <label for="itemNo">Item No.</label>
    <input type="text" name="itemNo" id="itemNo" required>
  </div>

  <div class="row">
    <label for="customerName">Customer Name</label>
    <input type="text" name="customerName" id="customerName" required>
  </div>

  <div class="row">
    <label for="itemName">Item Name</label>
    <input type="text" name="itemName" id="itemName" required>
  </div>

  <div class="row">
    <label for="defectDesc">Defect Description</label>
    <textarea name="defectDesc" id="defectDesc" rows="3" required></textarea>
  </div>

  <div class="row">
    <label for="defectCount">Defective Item Count</label>
    <input type="number" name="defectCount" id="defectCount" required>
  </div>

  <div class="row">
    <label>Photos (up to 5)</label>
    <button type="button" id="addPhotoBtn">üì∑ Add Photo / Upload</button>
    <input type="file" accept="image/*" capture="environment" id="hiddenPhotoInput" style="display:none;">
  </div>

  <input type="hidden" name="user" id="userField">
  <input type="hidden" name="imageBase64_1" id="imageBase64_1">
  <input type="hidden" name="imageBase64_2" id="imageBase64_2">
  <input type="hidden" name="imageBase64_3" id="imageBase64_3">
  <input type="hidden" name="imageBase64_4" id="imageBase64_4">
  <input type="hidden" name="imageBase64_5" id="imageBase64_5">

  <div class="photoContainer" id="photoContainer"></div>

  <button type="submit">Submit</button>
</form>

<div id="submitMessage"></div>
<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
const maxPhotos = 5;
let photos = []; // {file, base64}
const photoContainer = document.getElementById('photoContainer');
const hiddenInput = document.getElementById('hiddenPhotoInput');

function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

// Ëá™Âä®Â°´ÂÖ• user
const userFromUrl = getQueryParam('user');
if (userFromUrl) document.getElementById('userField').value = userFromUrl;

async function compressImage(file, maxWidth = 1024, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const scale = Math.min(1, maxWidth / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

async function addPhoto(file) {
  if (photos.length >= maxPhotos) {
    alert(`You can upload up to ${maxPhotos} photos only.`);
    return;
  }
  const compressed = await compressImage(file);
  const base64 = await blobToBase64(compressed);
  photos.push({file: compressed, base64});

  updatePhotoContainer();
}

function updatePhotoContainer() {
  photoContainer.innerHTML = '';
  photos.forEach((p, idx) => {
    const div = document.createElement('div');
    div.className = 'photoItem';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(p.file);
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = '√ó';
    btn.className = 'removeBtn';
    btn.onclick = () => {
      photos.splice(idx, 1);
      updatePhotoContainer();
    };
    div.appendChild(img);
    div.appendChild(btn);
    photoContainer.appendChild(div);

    // Êõ¥Êñ∞ÈöêËóè input
    document.getElementById(`imageBase64_${idx+1}`).value = p.base64;
  });

  // Ê∏ÖÁ©∫Ââ©‰ΩôÈöêËóè input
  for (let i = photos.length; i < maxPhotos; i++) {
    document.getElementById(`imageBase64_${i+1}`).value = '';
  }
}

// ÁÇπÂáªÊåâÈíÆÊâìÂºÄÊñá‰ª∂ÈÄâÊã©
document.getElementById('addPhotoBtn').addEventListener('click', () => {
  hiddenInput.click();
});

// Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
hiddenInput.addEventListener('change', async e => {
  if (!e.target.files || e.target.files.length === 0) return;
  for (const f of e.target.files) await addPhoto(f);
  e.target.value = '';
});

// Êèê‰∫§È™åËØÅ
document.getElementById('defectForm').addEventListener('submit', e => {
  if (photos.length === 0) {
    e.preventDefault();
    alert("Please take a photo or choose an image before submitting.");
    return;
  }
  document.getElementById('submitMessage').textContent = "Submitting...";
});

// ÊàêÂäüÂõûË∞É
document.querySelector('iframe[name="hidden_iframe"]').addEventListener('load', () => {
  document.getElementById('submitMessage').textContent = "Form submitted successfully!";
  alert("Form submitted successfully!");
});
</script>

</body>
</html>
